<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0099CC">
    <title>WHO Bhutan Visitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .login-card {
            background: #000000;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 420px;
        }

        .login-logo {
            width: 100%;
            max-width: 300px;
            height: auto;
            display: block;
            margin: 0 auto 30px;
        }

        .login-card h1 {
            font-size: 24px;
            margin-bottom: 8px;
            text-align: center;
            color: #2d3748;
        }

        .login-card .subtitle {
            color: #718096;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .error-msg {
            background: #fed7d7;
            color: #742a2a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        .setup-notice {
            background: #fef3c7;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.5;
        }

        .setup-notice strong {
            display: block;
            margin-bottom: 5px;
        }

        /* Header */
        .header {
            background: white;
            color: #2d3748;
            padding: 15px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .header-logo-container {
            background: transparent;
            padding: 10px 15px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .header-logo {
            max-width: 200px;
            height: auto;
            display: block;
        }

        .header h1 {
            font-size: 16px;
            margin-bottom: 4px;
            color: #2d3748;
        }

        .header .date {
            font-size: 12px;
            color: #718096;
        }

        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .user-badge {
            background: #e0f2fe;
            color: #0369a1;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 500;
        }

        .logout-btn {
            background: #f56565;
            border: none;
            color: white;
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #0ea5e9;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 16px;
            background: white;
            margin-bottom: 10px;
        }

        .stat-card {
            text-align: center;
            padding: 16px 8px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border-radius: 12px;
        }

        .stat-card h3 {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .stat-card p {
            font-size: 11px;
            opacity: 0.9;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 calc(env(safe-area-inset-bottom) + 10px);
            z-index: 100;
        }

        .nav-btn {
            flex: 1;
            border: none;
            background: none;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #718096;
            font-size: 20px;
            cursor: pointer;
        }

        .nav-btn span {
            font-size: 11px;
        }

        .nav-btn.active {
            color: #0ea5e9;
        }

        /* Screens */
        .screen {
            display: none;
            padding: 0 16px 20px;
        }

        .screen.active {
            display: block;
        }

        /* Form Styles */
        .form-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 16px;
        }

        .form-card h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0ea5e9;
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .visitor-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .visitor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .visitor-name {
            font-weight: 600;
            font-size: 16px;
            color: #2d3748;
        }

        .visitor-company {
            font-size: 13px;
            color: #718096;
            margin-top: 2px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.inside {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-badge.left {
            background: #fed7d7;
            color: #742a2a;
        }

        .visitor-details {
            display: grid;
            gap: 8px;
            margin-bottom: 12px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .detail-label {
            color: #718096;
        }

        .detail-value {
            color: #2d3748;
            font-weight: 500;
        }

        .visitor-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-checkout {
            background: #4299e1;
            color: white;
        }

        .btn-delete {
            background: #f56565;
            color: white;
        }

        .search-bar {
            background: white;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
        }

        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
        }

        .filter-btn.active {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .hidden {
            display: none !important;
        }

        .admin-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .admin-card h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #2d3748;
        }

        .user-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #2d3748;
        }

        .user-role {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .add-user-grid {
            display: grid;
            gap: 12px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <img src="WHO-CO-BHU-logo_Blue.png" alt="WHO Bhutan Logo" class="login-logo">
            <h1>Visitor Dashboard</h1>
            <p class="subtitle">Please login to continue</p>
            
            <div class="setup-notice" id="setupNotice">
                <strong>‚ö†Ô∏è Setup Required</strong>
                Please update the SCRIPT_URL in the code with your Google Apps Script deployment URL.
            </div>
            
            <div id="loginError" class="error-msg"></div>
            <div class="loading" id="loginLoading">
                <div class="spinner"></div>
                <p>Connecting...</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <div class="header">
            <div class="header-logo-container">
                <img src="WHO-CO-BHU-logo_Blue.png" alt="WHO Bhutan" class="header-logo">
            <h1>Visitor Dashboard</h1>
            <p class="date" id="currentDate"></p>
            <div class="user-bar">
                <span class="user-badge" id="userBadge">üë§ Admin</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="todayVisitors">0</h3>
                <p>Today</p>
            </div>
            <div class="stat-card">
                <h3 id="currentlyInside">0</h3>
                <p>Inside</p>
            </div>
            <div class="stat-card">
                <h3 id="totalVisitors">0</h3>
                <p>Total</p>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="mainLoading">
            <div class="spinner"></div>
            <p>Loading data...</p>
        </div>

        <!-- Check-In Screen -->
        <div id="checkinScreen" class="screen active">
            <div class="form-card">
                <h2>‚úçÔ∏è New Visitor Check-In</h2>
                <form id="visitorForm">
                    <div class="form-group">
                        <label>Visitor Name *</label>
                        <input type="text" id="visitorName" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Company/Organization</label>
                        <input type="text" id="company">
                    </div>
                    
                    <div class="form-group">
                        <label>Contact Number</label>
                        <input type="tel" id="contact">
                    </div>
                    
                    <div class="form-group">
                        <label>Person to Meet *</label>
                        <select id="hostName" required>
                            <option value="">-- Select Person --</option>
                            <option value="WR">Dr Bhupinder Kaur Aulakh</option>
                            <option value="Jamyang Choden">Jamyang Choden</option>
                            <option value="Thinley Wangmo">Thinley Wangmo</option>
                            <option value="Kencho Wangdi">Kencho Wangdi</option>
                            <option value="Sonam Chhoki">Sonam Chhoki</option>
                            <option value="Dechen Choden">Dechen Choden</option>
                            <option value="Dr Lobzang Dorji">Dr Lobzang Dorji</option>
                            <option value="Wangchuk">Wangchuk</option>
                            <option value="Sonam Tobgye">Sonam Tobgye</option>
                            <option value="Pema Lethro">Pema Lethro</option>
                            <option value="Sonam Yangchen">Sonam Yangchen</option>
                            <option value="Kinga Namgyel">Kinga Namgyel</option>
                            <option value="Jigme Lhendup">Jigme Lhendup</option>
                            <option value="Tashi Tenzin">Tashi Tenzin</option>
                            <option value="Thukten">Thukten</option>
                            <option value="Dawa Penjor">Dawa Penjor</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Purpose of Visit</label>
                        <select id="purpose">
                            <option value="Meeting">Meeting</option>
                            <option value="Interview">Interview</option>
                            <option value="Delivery">Delivery</option>
                            <option value="Consultation">Consultation</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn-primary" id="checkinBtn">Check-In Visitor</button>
                </form>
            </div>
        </div>

        <!-- Visitors Screen -->
        <div id="visitorsScreen" class="screen">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="üîç Search visitors...">
            </div>

            <div class="filters">
                <button class="filter-btn active" data-status="all" onclick="filterStatus('all')">All</button>
                <button class="filter-btn" data-status="checked-in" onclick="filterStatus('checked-in')">Inside</button>
                <button class="filter-btn" data-status="checked-out" onclick="filterStatus('checked-out')">Left</button>
                <button class="filter-btn" data-date="today" onclick="filterDate('today')">Today</button>
                <button class="filter-btn" data-date="week" onclick="filterDate('week')">This Week</button>
            </div>

            <button class="export-btn" onclick="exportToCSV()">üì• Export to CSV</button>

            <div id="visitorsList"></div>
        </div>

        <!-- Admin Screen -->
        <div id="adminScreen" class="screen">
            <div class="admin-card">
                <h3>üë• Manage Users</h3>
                <form id="addUserForm" class="add-user-grid">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="newUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="userRole">
                            <option value="admin">Admin</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Add User</button>
                </form>
            </div>

            <div class="admin-card">
                <h3>üìã User List</h3>
                <div id="usersList"></div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchScreen('checkin')">
                ‚úçÔ∏è
                <span>Check-In</span>
            </button>
            <button class="nav-btn" onclick="switchScreen('visitors')">
                üìã
                <span>Visitors</span>
            </button>
            <button class="nav-btn" id="adminNavBtn" onclick="switchScreen('admin')">
                ‚öôÔ∏è
                <span>Admin</span>
            </button>
        </div>
    </div>

    <script>
        // IMPORTANT: Replace this with your Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxIYIN3SA9_jKqKm8ZEzKq6h7-T5p5a6Z8QSuFGJkLGMnlLtr7KZOtFCa45h7UEd2vloQ/exec';
        
        // State
        let currentUser = null;
        let users = [];
        let visitors = [];
        let currentStatusFilter = 'all';
        let currentDateFilter = 'all';

        // Check if setup is complete
        function checkSetup() {
            if (SCRIPT_URL === 'YOUR_SCRIPT_URL_HERE') {
                document.getElementById('setupNotice').style.display = 'block';
                return false;
            }
            document.getElementById('setupNotice').style.display = 'none';
            return true;
        }

        // API Functions
        async function loadUsers() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getUsers`);
                const data = await response.json();
                users = data.users || [];
            } catch (error) {
                console.error('Error loading users:', error);
                alert('‚ùå Error connecting to database. Please check your setup.');
            }
        }

        async function loadVisitors() {
            try {
                document.getElementById('mainLoading').classList.add('active');
                const response = await fetch(`${SCRIPT_URL}?action=getVisitors`);
                const data = await response.json();
                visitors = data.visitors || [];
                updateStats();
                renderVisitors();
            } catch (error) {
                console.error('Error loading visitors:', error);
                alert('‚ùå Error loading visitors from database.');
            } finally {
                document.getElementById('mainLoading').classList.remove('active');
            }
        }

        async function saveVisitor(visitorData) {
            try {
                // Build URL with parameters (avoids CORS preflight)
                const params = new URLSearchParams({
                    action: 'addVisitor',
                    id: visitorData.id,
                    name: visitorData.name,
                    company: visitorData.company,
                    contact: visitorData.contact,
                    host: visitorData.host,
                    purpose: visitorData.purpose,
                    checkInTime: visitorData.checkInTime,
                    checkOutTime: visitorData.checkOutTime,
                    status: visitorData.status,
                    checkedInBy: visitorData.checkedInBy
                });
                
                console.log('Sending to server:', params.toString());
                
                const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
                
                const responseText = await response.text();
                console.log('Server response:', responseText);
                
                const data = JSON.parse(responseText);
                return data.success;
            } catch (error) {
                console.error('Error saving visitor:', error);
                alert('Error details: ' + error.message);
                return false;
            }
        }

        // Auth
        async function checkAuth() {
            if (!checkSetup()) return;
            
            document.getElementById('loginLoading').classList.add('active');
            await loadUsers();
            document.getElementById('loginLoading').classList.remove('active');
            
            currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                showApp();
            } else {
                showLogin();
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!checkSetup()) {
                alert('‚ö†Ô∏è Please complete the setup first. Check the instructions.');
                return;
            }
            
            // Show loading
            document.getElementById('loginLoading').classList.add('active');
            
            // Reload users from Google Sheets to get latest users
            await loadUsers();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = users.find(u => u.username === username && u.password === password);
            
            document.getElementById('loginLoading').classList.remove('active');
            
            if (user) {
                currentUser = { username: user.username, role: user.role };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                showApp();
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = '‚ùå Invalid username or password';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
            }
        });

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        async function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userBadge').textContent = `üë§ ${currentUser.username}`;
            
            if (currentUser.role !== 'admin') {
                document.getElementById('adminNavBtn').classList.add('hidden');
            }
            
            updateDate();
            await loadVisitors();
        }

        function logout() {
            sessionStorage.removeItem('currentUser');
            document.getElementById('loginForm').reset();
            showLogin();
        }

        // Navigation
        function switchScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            if (screen === 'checkin') {
                document.getElementById('checkinScreen').classList.add('active');
                event.target.closest('.nav-btn').classList.add('active');
            } else if (screen === 'visitors') {
                document.getElementById('visitorsScreen').classList.add('active');
                event.target.closest('.nav-btn').classList.add('active');
                loadVisitors();
            } else if (screen === 'admin') {
                document.getElementById('adminScreen').classList.add('active');
                event.target.closest('.nav-btn').classList.add('active');
                renderUsersList();
            }
        }

        // Date & Stats
        function updateDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }

        function updateStats() {
            const today = new Date().toDateString();
            const todayVisitors = visitors.filter(v => new Date(v.checkInTime).toDateString() === today);
            const currentlyInside = visitors.filter(v => v.status === 'checked-in');

            document.getElementById('todayVisitors').textContent = todayVisitors.length;
            document.getElementById('currentlyInside').textContent = currentlyInside.length;
            document.getElementById('totalVisitors').textContent = visitors.length;
        }

        // Check-in
        document.getElementById('visitorForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const btn = document.getElementById('checkinBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            const visitorData = {
                id: Date.now(),
                name: document.getElementById('visitorName').value,
                company: document.getElementById('company').value,
                contact: document.getElementById('contact').value,
                host: document.getElementById('hostName').value,
                purpose: document.getElementById('purpose').value,
                checkInTime: new Date().toISOString(),
                checkOutTime: '',
                status: 'checked-in',
                checkedInBy: currentUser.username
            };

            const success = await saveVisitor(visitorData);
            
            if (success) {
                this.reset();
                await loadVisitors();
                alert('‚úÖ Visitor checked in successfully!');
            } else {
                alert('‚ùå Error saving visitor. Please try again.');
            }
            
            btn.disabled = false;
            btn.textContent = 'Check-In Visitor';
        });

        // Filters
        function filterStatus(status) {
            currentStatusFilter = status;
            document.querySelectorAll('[data-status]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });
            renderVisitors();
        }

        function filterDate(date) {
            currentDateFilter = date;
            document.querySelectorAll('[data-date]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.date === date);
            });
            renderVisitors();
        }

        document.getElementById('searchInput').addEventListener('input', renderVisitors);

        // Render visitors
        function renderVisitors() {
            const container = document.getElementById('visitorsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = visitors.filter(v => {
                const matchesSearch = v.name.toLowerCase().includes(searchTerm) ||
                                    (v.company || '').toLowerCase().includes(searchTerm) ||
                                    v.host.toLowerCase().includes(searchTerm);
                
                const matchesStatus = currentStatusFilter === 'all' || v.status === currentStatusFilter;
                
                let matchesDate = true;
                if (currentDateFilter === 'today') {
                    matchesDate = new Date(v.checkInTime).toDateString() === new Date().toDateString();
                } else if (currentDateFilter === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    matchesDate = new Date(v.checkInTime) >= weekAgo;
                }

                return matchesSearch && matchesStatus && matchesDate;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>No visitors found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(v => `
                <div class="visitor-card">
                    <div class="visitor-card-header">
                        <div>
                            <div class="visitor-name">${v.name}</div>
                            <div class="visitor-company">${v.company || 'No company'}</div>
                        </div>
                        <span class="status-badge ${v.status === 'checked-in' ? 'inside' : 'left'}">
                            ${v.status === 'checked-in' ? 'Inside' : 'Left'}
                        </span>
                    </div>
                    <div class="visitor-details">
                        <div class="detail-row">
                            <span class="detail-label">Host:</span>
                            <span class="detail-value">${v.host}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Purpose:</span>
                            <span class="detail-value">${v.purpose}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Check-In:</span>
                            <span class="detail-value">${new Date(v.checkInTime).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ${v.checkOutTime ? `
                        <div class="detail-row">
                            <span class="detail-label">Check-Out:</span>
                            <span class="detail-value">${new Date(v.checkOutTime).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="visitor-actions">
                        ${v.status === 'checked-in' ? 
                            `<button class="btn-small btn-checkout" onclick="checkOut(${v.id})">Check Out</button>` : ''}
                        ${currentUser.role === 'admin' ? 
                            `<button class="btn-small btn-delete" onclick="deleteVisitor(${v.id})">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function checkOut(id) {
            const visitor = visitors.find(v => v.id === id);
            if (visitor) {
                visitor.checkOutTime = new Date().toISOString();
                visitor.status = 'checked-out';
                
                const params = new URLSearchParams({
                    action: 'updateVisitor',
                    id: id,
                    checkOutTime: visitor.checkOutTime,
                    status: visitor.status
                });
                
                await fetch(`${SCRIPT_URL}?${params.toString()}`);
                
                await loadVisitors();
            }
        }

        async function deleteVisitor(id) {
            if (confirm('Delete this visitor record?')) {
                const params = new URLSearchParams({
                    action: 'deleteVisitor',
                    id: id
                });
                
                await fetch(`${SCRIPT_URL}?${params.toString()}`);
                
                await loadVisitors();
            }
        }

        // Admin
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('userRole').value;

            if (users.find(u => u.username === username)) {
                alert('‚ùå Username already exists!');
                return;
            }

            const params = new URLSearchParams({
                action: 'addUser',
                username: username,
                password: password,
                role: role
            });
            
            await fetch(`${SCRIPT_URL}?${params.toString()}`);
            
            this.reset();
            await loadUsers();
            renderUsersList();
            alert('‚úÖ User added!');
        });

        function renderUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = users.map(u => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-name">${u.username}</div>
                        <div class="user-role">${u.role}</div>
                    </div>
                    ${u.username !== 'admin' ? 
                        `<button class="btn-small btn-delete" onclick="deleteUser('${u.username}')">Delete</button>` : 
                        '<span style="font-size: 11px; color: #a0aec0;">Default</span>'}
                </div>
            `).join('');
        }

        async function deleteUser(username) {
            if (confirm(`Delete user "${username}"?`)) {
                const params = new URLSearchParams({
                    action: 'deleteUser',
                    username: username
                });
                
                await fetch(`${SCRIPT_URL}?${params.toString()}`);
                
                await loadUsers();
                renderUsersList();
            }
        }

        // Export
        function exportToCSV() {
            const headers = ['Name', 'Company', 'Contact', 'Host', 'Purpose', 'Check-In', 'Check-Out', 'Status'];
            const csvContent = [
                headers.join(','),
                ...visitors.map(v => [
                    v.name,
                    v.company || '',
                    v.contact || '',
                    v.host,
                    v.purpose,
                    new Date(v.checkInTime).toLocaleString(),
                    v.checkOutTime ? new Date(v.checkOutTime).toLocaleString() : '',
                    v.status
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `WHO_visitors_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
